<div class="add-recette-container">
  <div class="add-recette-wrapper">
    <h1>Ajouter une nouvelle recette</h1>

    <!-- Messages de succ√®s/erreur -->
    <div *ngIf="successMessage" class="alert alert-success">
      <p>{{ successMessage }}</p>
    </div>

    <div *ngIf="errorMessage" class="alert alert-error">
      <p>{{ errorMessage }}</p>
    </div>

    <!-- Formulaire -->
    <form [formGroup]="recetteForm" (ngSubmit)="onSubmit()" class="recette-form">
      
      <!-- Titre -->
      <div class="form-group">
        <label for="titre_recette">Titre de la recette *</label>
        <input 
          type="text" 
          id="titre_recette" 
          formControlName="titre_recette"
          class="form-control"
          [class.is-invalid]="submitted && titre_recette?.invalid"
          placeholder="Ex: G√¢teau au chocolat">
        <div *ngIf="submitted && titre_recette?.invalid" class="error-message">
          <p *ngIf="titre_recette?.errors?.['required']">Le titre est obligatoire</p>
          <p *ngIf="titre_recette?.errors?.['minlength']">Le titre doit contenir au moins 3 caract√®res</p>
        </div>
      </div>

      <!-- Description -->
      <div class="form-group">
        <label for="description_recette">Description *</label>
        <textarea 
          id="description_recette" 
          formControlName="description_recette"
          class="form-control"
          [class.is-invalid]="submitted && description_recette?.invalid"
          placeholder="D√©crivez votre recette..."
          rows="5"></textarea>
        <div *ngIf="submitted && description_recette?.invalid" class="error-message">
          <p *ngIf="description_recette?.errors?.['required']">La description est obligatoire</p>
        </div>
      </div>

      <!-- Cat√©gorie -->
      <div class="form-group">
        <div class="label-with-button">
          <label for="categorieId">Cat√©gorie</label>
          <button type="button" class="btn-small" (click)="reloadCategories()" *ngIf="categories.length === 0">
            üîÑ Recharger
          </button>
        </div>
        <select 
          id="categorieId" 
          formControlName="categorieId"
          class="form-control"
          [class.is-invalid]="submitted && categorieId?.invalid">
          <option value="">S√©lectionnez une cat√©gorie</option>
          <option *ngFor="let cat of categories" [value]="cat.id">
            {{ cat.nom_categorie }}
          </option>
        </select>
        <div *ngIf="categories.length === 0" class="warning-message">
          <p>‚ö†Ô∏è Aucune cat√©gorie charg√©e. Cliquez sur "Recharger" ou <button type="button" class="btn-link" (click)="toggleCreateCategoryForm()">cr√©ez-en une</button>.</p>
        </div>
        <div *ngIf="submitted && categorieId?.invalid" class="error-message">
          <p *ngIf="categorieId?.errors?.['required']">La cat√©gorie est obligatoire</p>
        </div>
      </div>

      <!-- Formulaire de cr√©ation de cat√©gorie -->
      <div *ngIf="showCreateCategoryForm" class="create-category-section">
        <h4>‚ûï Cr√©er une nouvelle cat√©gorie</h4>
        <div class="form-group">
          <label for="newCategoryName">Nom de la cat√©gorie *</label>
          <div class="input-with-button">
            <input 
              type="text" 
              id="newCategoryName" 
              [(ngModel)]="newCategoryName"
              class="form-control"
              placeholder="Ex: P√¢tes, Salades, Snacks..."
              (keyup.enter)="createCategory()">
            <button 
              type="button" 
              class="btn btn-success"
              (click)="createCategory()"
              [disabled]="creatingCategory || !newCategoryName.trim()">
              {{ creatingCategory ? 'Cr√©ation...' : 'Cr√©er' }}
            </button>
            <button 
              type="button" 
              class="btn btn-secondary"
              (click)="toggleCreateCategoryForm()"
              [disabled]="creatingCategory">
              Annuler
            </button>
          </div>
        </div>
      </div>
      <button type="button" class="btn-link" (click)="toggleCreateCategoryForm()" *ngIf="!showCreateCategoryForm">
        ‚ûï Cr√©er une cat√©gorie
      </button>

      <!-- Photo (optionnel) -->
      <div class="form-group">
        <label for="photo_file">Photo de la recette (optionnel)</label>
        <div class="image-upload">
          <input 
            type="file" 
            id="photo_file" 
            accept="image/*"
            class="file-input"
            (change)="onImageSelected($event)">
          <label for="photo_file" class="file-label">
            üì∏ Cliquez pour s√©lectionner une image
          </label>
        </div>

        <!-- Pr√©visualisation de l'image -->
        <div *ngIf="imagePreview" class="image-preview">
          <img [src]="imagePreview" alt="Pr√©visualisation">
          <button type="button" class="btn-remove-image" (click)="removeImage()">‚ùå Supprimer</button>
        </div>

        <div *ngIf="!imagePreview && !selectedFile" class="upload-info">
          <p>üí° Formats accept√©s: JPG, PNG, GIF | Max: 5MB</p>
        </div>
      </div>

      <!-- √âtapes -->
      <div class="section-header">
        <h3>√âtapes de pr√©paration</h3>
        <button type="button" class="btn-add" (click)="addEtape()">‚ûï Ajouter une √©tape</button>
      </div>

      <div formArrayName="etapes" class="form-array">
        <div *ngIf="etapesArray.length === 0" class="empty-message">
          <p>Aucune √©tape ajout√©e. Cliquez sur le bouton ci-dessus pour en ajouter.</p>
        </div>

        <div *ngFor="let etape of etapesArray.controls; let i = index" [formGroupName]="i" class="array-item">
          <div class="array-header">
            <h4>√âtape {{ i + 1 }}</h4>
            <button type="button" class="btn-remove" (click)="removeEtape(i)">‚ùå</button>
          </div>

          <div class="form-group">
            <label for="description_etape_{{ i }}">Description de l'√©tape *</label>
            <textarea 
              [id]="'description_etape_' + i" 
              formControlName="description_etape"
              class="form-control"
              [class.is-invalid]="submitted && etape.get('description_etape')?.invalid"
              placeholder="D√©crivez cette √©tape..."
              rows="3"></textarea>
            <div *ngIf="submitted && etape.get('description_etape')?.invalid" class="error-message">
              <p *ngIf="etape.get('description_etape')?.errors?.['required']">La description est obligatoire</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Ingr√©dients -->
      <div class="section-header">
        <h3>Ingr√©dients</h3>
        <button type="button" class="btn-add" (click)="addIngredient()">‚ûï Ajouter un ingr√©dient</button>
      </div>

      <div formArrayName="ingredients" class="form-array">
        <div *ngIf="ingredientsArray.length === 0" class="empty-message">
          <p>Aucun ingr√©dient ajout√©. Cliquez sur le bouton ci-dessus pour en ajouter.</p>
        </div>

        <div *ngFor="let ingredient of ingredientsArray.controls; let i = index" [formGroupName]="i" class="array-item">
          <div class="array-header">
            <h4>Ingr√©dient {{ i + 1 }}</h4>
            <button type="button" class="btn-remove" (click)="removeIngredient(i)">‚ùå</button>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="nom_ingredient_{{ i }}">Nom de l'ingr√©dient *</label>
              <input 
                type="text" 
                [id]="'nom_ingredient_' + i" 
                formControlName="nom_ingredient"
                class="form-control"
                [class.is-invalid]="submitted && ingredient.get('nom_ingredient')?.invalid"
                placeholder="Ex: Farine">
              <div *ngIf="submitted && ingredient.get('nom_ingredient')?.invalid" class="error-message">
                <p *ngIf="ingredient.get('nom_ingredient')?.errors?.['required']">Le nom est obligatoire</p>
              </div>
            </div>

            <div class="form-group">
              <label for="quantite_{{ i }}">Quantit√© *</label>
              <input 
                type="text" 
                [id]="'quantite_' + i" 
                formControlName="quantite"
                class="form-control"
                [class.is-invalid]="submitted && ingredient.get('quantite')?.invalid"
                placeholder="Ex: 2 tasses">
              <div *ngIf="submitted && ingredient.get('quantite')?.invalid" class="error-message">
                <p *ngIf="ingredient.get('quantite')?.errors?.['required']">La quantit√© est obligatoire</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Boutons -->
      <div class="form-actions">
        <button 
          type="submit" 
          class="btn btn-primary"
          [disabled]="loading">
          <span *ngIf="loading">Cr√©ation en cours...</span>
          <span *ngIf="!loading">Ajouter la recette</span>
        </button>
        <button 
          type="button" 
          class="btn btn-secondary"
          (click)="cancel()"
          [disabled]="loading">
          Annuler
        </button>
      </div>
    </form>
  </div>
</div>
